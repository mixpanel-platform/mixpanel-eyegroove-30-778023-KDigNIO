<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="eventSelect" style="float: left;"></div>
      <div id="by" class="mixpanel-platform-label" style="margin-left: 10px; display: none;">by</div>
      <div id="propSelect" style="float: left;"></div>
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
      <div id="graph"></div>
    </div>
    <div id="table"></div>
    <script>
      var dateSelect  = $('#dateSelect').MPDatepicker();
      var eventGraph  = $('#graph').MPChart({chartType: 'line'});
      var eventTable  = $('#table').MPTable({
        showPercentages: true,
        firstColHeader: 'Event'
      });
      
      var eventName = "User Follow";
      var dateRange = dateSelect.MPDatepicker('value');

      if (eventName) {
        MP.api.segment(eventName, [], dateRange).done(function(results) {
          window.uniqueFollows = results;
          var toDate = dateRange.to.getFullYear() + '-' + (dateRange.to.getMonth()+1) + '-' +  dateRange.to.getDate();
          var fromDate = dateRange.from.getFullYear() + '-' + (dateRange.from.getMonth()+1) + '-' +  dateRange.from.getDate();
          MP.api.query('/api/2.0/events/', {event: ["Groove View", "Groove Record Clip", "Search", "App Background", "Groove Create Start", "Groove Create Start Choice", "Groove Song Region", "App Launch", "Groove Song Choose Category", "Groove Choose Song", "Groove Song Scrub Waveform", "App Resume"], unit: 'day', to_date:toDate, from_date : fromDate, union:1, type: 'unique'}, {dataType: 'json'})
          .done(function(activeUsers) {
              /* Where calculation and graphing will take place */
              var networkDensity = {};
              networkDensity['Network Density'] = {};
              for (var date in window.uniqueFollows.values()['User Follow']) {
                if (window.uniqueFollows.values()['User Follow'].hasOwnProperty(date)) {
                  var nodes = activeUsers['data']['values']["[u'Groove View', u'Groove Record Clip', u'Search', u'App Background', u'Groove Create Start', u'Groove Create Start Choice', u'Groove Song Region', u'App Launch', u'Groove Song Choose Category', u'Groove Choose Song', u'Groove Song Scrub Waveform', u'App Resume']"][date];
                  var potentialConnections = (nodes*(nodes-1))/2;
                  var actualConnections = window.uniqueFollows.values()['User Follow'][date];
                  networkDensity['Network Density'][date] = actualConnections/potentialConnections;
                  //console.log("Potential Connections: "+potentialConnections+", actual connections: "+actualConnections);
                }
              }
              eventGraph.MPChart('setData', networkDensity);
              eventTable.MPTable('setData', networkDensity);
          })
          .fail(function($xhr) {
              console.log('error with request', $xhr);
          });
          
        });
      }
      
      var runQuery = function() {
        var eventName = "User Follow";
        var dateRange = dateSelect.MPDatepicker('value');
        console.log(dateRange);
        if (eventName) {
          MP.api.segment(eventName, [], dateRange).done(function(results) {
            console.log(results.values());
            eventGraph.MPChart('setData', results);
            eventTable.MPTable('setData', results);
          });
        }
      };
      
      dateSelect.on('change', runQuery);
    </script>
  </body>
</html>
